<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&family=Sono:wght@200..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/cart.css">
    <title>Home</title>
</head>
<style>
    
</style>
<body>
    <nav class="navigation">
        <div class="logo">
            <a href=""><img src="../system/newlogo.png" alt="Stride Sync"></a>
        </div>
        <div class="item">
            <div class="route">
                <ul>
                    <a href="/"><li><ion-icon name="home-outline"></ion-icon> <p>Home</p> </li></a>
                    <a href="/products"><li><ion-icon name="grid-outline"></ion-icon> <p>Products</p> </li></a>
                    <a href=""><li><ion-icon name="newspaper-outline"></ion-icon> <p>What New?</p> </li></a>
                    <a href=""><li><ion-icon name="help-circle-outline"></ion-icon> <p>About Us</p> </li></a>
                </ul>
            </div>
            <div class="account">
                <h4>ACCOUNT</h4>
                <ul>
                    <a href="/myinfo"><li><ion-icon name="person-outline"></ion-icon> <p>My Info</p> </li></a>
                    <a href=""><li id="here"><ion-icon name="cart-outline"></ion-icon> <p>My Orders</p> </li></a>
                    <a href=""><li><ion-icon name="settings-outline"></ion-icon> <p>Setting</p> </li></a>
                </ul>
            </div>
            <div id="helpCenter" class="help-center">
                <span><ion-icon name="mail-outline"></ion-icon></span>
                <h3>Contact Us</h3>
                <p>Having trouble in StrideSync. Please contact us for more questions.</p>
                <button class="btn-help">Go to contact</button>
                <span id="glass"></span>
            </div>
        </div>
    </nav>
    <section>
        <header>
            <div class="welcome-box">
            </div>
            <div class="search-box" id="fixedBox">
                <span class="fixed-search">
                    <input type="text" id="searchInput" placeholder="Search at here...">
                    <button id="moreOpt"><ion-icon name="options-outline"></ion-icon></button>
                </span>
            </div>
            <div class="user-box">
                <span class="user-avt">
                    <img id="user-avatar" src="../avt.png" alt="">
                </span>
            </div>
        </header>
        <div class="container">
            <div class="my-cart">
                <h1>My cart</h1>
                <div id="cartProducts">
                    <p style="margin-top: 1rem; font-size: 20px;">There are no products in your cart</p>
                </div>
            </div>
            <div class="summary">
                <h1>Summary</h1>
                <div class="content-billing">
                    <span>
                        <p class="title">Subtotal</p>
                        <p id="subtotal"></p>
                    </span>
                    <span>
                        <p class="title">Estimated Delivery & Handling</p>
                        <p class="">Free</p>
                    </span>
                    <span>
                        <p class="title">VAT</p>
                        <p class="">8%</p>
                    </span>
                </div>
                <div class="total">
                    <h4>Total</h4>
                    <p id="cartTotal"></p>
                </div>
                <button class="check-out">Check-out</button>
            </div>
        </div>
    </section>
    <footer>

    </footer>
    <script>
        const fixedBox = document.getElementById("fixedBox");
        const btnMoreOpt = document.getElementById("moreOpt")
        const searchInput = document.getElementById("searchInput");
        //const category = document.getElementById("price");
        let searchExpand = false;
        let timerId;
        document.addEventListener("click", function(e){
            
            // if(parentNode.parentNode == "searchInput" || parentNode.id == "moreOpt"){
            let element = checkParentNode(e.target);

            if(e.target.id == "searchInput"){
                expandDiv.style.display = "block";
                searchExpand = false;
            }else if(e.target.id == "moreOpt"){
                expandDiv.style.display = "block";
                searchExpand = !searchExpand;
            }else if(element.id == "expandDiv" && element.id){
                expandDiv.style.display = "block";
            }else{
                expandDiv.style.display = "none";
                searchExpand = false;
            }

            function checkParentNode(element){
                while (element.parentNode && element.parentNode !== fixedBox) {
                    let highestParent = null;
                    highestParent = element.parentNode;
                    element = highestParent;
                }
                return element || null;
            }
            
            handleMoreOptClick()

            function handleMoreOptClick() {
                const expandDiv = document.getElementById("expandDiv");
                expandDiv.classList.toggle("expanded");
                if (searchExpand) {
                    // searchExpand = false;
                    // expandDiv.style.display = "block";
                    document.getElementById("filter").style.display = "block";
                    document.getElementById("searchResult").innerHTML = "";
                } else {
                    // expandDiv.style.display = "none";
                    // searchExpand = true;
                    document.getElementById("filter").style.display = "none";
                    if (searchInput.value && searchInput.value.trim() != "") {
                        const data = {
                            name: searchInput.value,
                        };
                        getSearch(data);
                    }
                }
            };

            function getSearch(data) {
                const queryParams = new URLSearchParams(data).toString();
                fetch(`/api/indexSearch?${queryParams}`, {
                    method: 'GET',
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        renderProducts(data.dt)
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Xử lý lỗi ở đây nếu cần thiết
                    });
            }

            function renderProducts(products) {
                let Html = ' ';
                if (products !== null && products.length > 0) {
                    products.forEach(product => {
                        Html += `<a href="" style="text-decoration: none; color: #222831;">`;
                        Html += checkTag(product);
                        Html += `<img src="${product.imageURL}" onerror="this.onerror=null; this.src='../productPic/ads.webp';" alt="Product Image" class="product-image">`;
                        Html += `<div class="product-info">`;
                        Html += `<h4 class="product-title">${product.name}</h4>`;
                        Html += `<span id="productPrice">`;
                        Html += `<p class="product-price old-price">$${product.price}</p>`;
                        Html += calSalePrice(product);
                        Html += `</span>`;
                        Html += `</div>`;
                        Html += `</div>`;
                        Html += `</a>`;
                    });
                }
                // Chèn vào phần tử có id là "container"
                var container = document.getElementById('searchResult');
                container.innerHTML = Html;
            }

            function calSalePrice(product) {
                if(product.sale !== false  && !isNaN(product.sale))
                {
                    return `<p id="newPrice">$${product.price - (product.price * product.sale / 100)}</p>`;
                }
                return `<p id="newPrice"></p>`;
            }

            function checkTag(product) {
                if (product.sale !== false && !isNaN(product.sale)) {
                    return `<div class="product-result sale-product" data-sale="${product.sale}%">`
                }
                if (product.isPopular !== false) {
                    return `<div class="product-result popular-product">`
                }
                return `<div class="product-result">`;
            }
            
        });
    </script>
    <script>
        fixedBox = document.getElementById("fixedBox");
        document.addEventListener("DOMContentLoaded", () =>{
            var lastScrollTop = 0;
            window.addEventListener("scroll", function (){
                var st = window.pageYOffset || document.documentElement.scrollTop;
                if (st > lastScrollTop || st == 0) {
                    fixedBox.style.top = 0 + "px"
                } else if (st < lastScrollTop) {
                    fixedBox.style.top = lastScrollTop + "px"
                }
                lastScrollTop = st <= 0 ? 0 : st;
            });

            getCartFromServer()
        })

        function getUserIdFromSessionStorage(){
            const _id = sessionStorage.getItem("_id");
            return _id;
        }

        async function getCartFromServer(){
            const data = {
                _id : await getUserIdFromSessionStorage()
            };
            const queryParams = new URLSearchParams(data).toString();
            fetch(`/api/getCarts?${queryParams}`, {
                method: 'GET',
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    cart = data.dt;
                    getProductInfo(cart);
                    renderCartProductsTotalAndSubtotal(cart);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Xử lý lỗi ở đây nếu cần thiết
                });
        }

        async function getProductInfo(cart) {
            if (!cart) {
                return;
            }
            const productIds = Object.keys(cart.item);
            let productInCart = [];
            for (const productId of productIds) {
                const productInfo = {
                    _id: productId
                };
                const searchResult = await getSearch(productInfo);
                productInCart.push(searchResult[0]);
            }
            renderCartProducts(productInCart, cart);
        }

        async function getSearch(data) {
            const queryParams = new URLSearchParams(data).toString();
            try {
                const response = await fetch(`/api/indexSearch?${queryParams}`, {
                    method: 'GET',
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const searchData = await response.json();
                return searchData.dt || 0;
            } catch (error) {
                console.error('Error:', error);
                return 0;
                // Xử lý lỗi ở đây nếu cần thiết
            }
        }


        function renderCartProducts(cartProducts, cart) {
            const cartProductsContainer = document.getElementById("cartProducts");
            cartProductsContainer.innerHTML = "";
            cartProducts.forEach(product => {
                productId = product._id;
                const productCard = document.createElement("div");
                productCard.classList.add("product-card-h");
                productCard.innerHTML = `
                    <img src="${product.imageURL}" alt="Product Image" class="product-image">
                    <div class="product-info">
                        <div>
                            <div class="data">
                                <h2 class="product-title">${product.name}</h2>
                                <span class="item">
                                    <p>Size</p>
                                    <select name="size" class="cartSizeBox SizeBox${productId}" onchange = "handleCartSizeBoxChange(event)">
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                        <option value="45">45</option>
                                    </select>
                                    <p>Quantity</p>
                                    <select name="quantity" class="cartQuantityBox QuantityBox${productId}" onchange = "handleCartQuantityBoxChange(event)">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                    </select>
                                </span>
                            </div>
                            <span class="productPrice">
                                ${checkSalePrice(product)}
                            </span>
                        </div>
                        <ion-icon name="trash-outline" onclick = "handleDeleteProductFromCart('${productId}')" class="delFromCart" data-product-id = "${productId}" style="font-size: 25px; height: 25px;"></ion-icon>
                    </div>
                `;
                cartProductsContainer.appendChild(productCard);
                handleCartQuantityBox(productId, cart.item[productId].quantity)
                handleCartSizeBox(productId, cart.item[productId].size)
            })
        }

        function handleCartQuantityBox(productId, quantity) {
            const selectElement = document.querySelector(`.QuantityBox${productId}`);
            if (selectElement) {
                selectElement.querySelectorAll("option").forEach(option => {
                    
                    if (option.value == quantity) {
                        option.selected = true;
                    }
                });
            }
        }

        function handleCartQuantityBoxChange(event) {
            const selectElement = event.target;
            const quantity = parseInt(selectElement.value);
            const productId = selectElement.closest(".product-card-h").querySelector(".product-info").querySelector(".delFromCart").getAttribute("data-product-id");
            const data = {
                _id: getUserIdFromSessionStorage(),
                productId: productId,
                quantity: quantity
            };

            updateCart(data);
            location.reload(true);
        }

        function handleCartSizeBoxChange(event) {
            const selectElement = event.target;
            const size = parseInt(selectElement.value);
            const productId = selectElement.closest(".product-card-h").querySelector(".product-info").querySelector(".delFromCart").getAttribute("data-product-id");
            const data = {
                _id: getUserIdFromSessionStorage(),
                productId: productId,
                size: size
            };
            console.log(data);
            updateCart(data);
            location.reload(true);
        }

        async function updateCart(data) {
            const queryParams = new URLSearchParams(data).toString();
            try {
                const response = await fetch(`/api/updateCart?${queryParams}`, {
                    method: 'GET',
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const searchData = await response.json();
                return searchData.ms;
            } catch (error) {
                console.error('Error:', error);
                return 0;
                // Xử lý lỗi ở đây nếu cần thiết
            }
        }

        function handleDeleteProductFromCart(productId) {
            const data = {
                _id: getUserIdFromSessionStorage(),
                productId: productId
            };
            deleteProductFromCart(data);
            location.reload(true);
        }

        function deleteProductFromCart(data) {
            const queryParams = new URLSearchParams(data).toString();
            fetch(`/api/deleteProductCart?${queryParams}`, {
                method: 'GET',
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    return data.ms;
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Xử lý lỗi ở đây nếu cần thiết
                });
        }

        function handleCartSizeBox(productId, Size) {
            const selectElement = document.querySelector(`.SizeBox${productId}`);
            if (selectElement) {
                selectElement.querySelectorAll("option").forEach(option => {
                    
                    if (option.value == Size) {
                        option.selected = true;
                    }
                });
            }
        }

        function checkSalePrice(product) {
            if (product.sale) {
               
                return ` <p class="product-price old-price">$${product.price}</p>
                         <p id="newPrice">$${product.price - (product.price * product.sale / 100)}</p>`;
            }
            return ` <p class="product-price">$${product.price}</p>`;
        }

        async function calculateCartSubtotal(cart) {
            let subtotal = 0;
            const cartProducts = cart.item;
            
            for (const productId in cartProducts) {
                if (cartProducts.hasOwnProperty(productId)) {
                    const product = cartProducts[productId];
                    const productInfo = {
                        _id: productId
                    };
                    try {
                        const searchResult = await getSearch(productInfo);
                        if (searchResult && searchResult.length > 0) {
                            const productData = searchResult[0];
                            if (productData.sale) {
                                subtotal += (productData.price - (productData.price * productData.sale / 100)) * product.quantity;
                            } else {
                                subtotal += productData.price * product.quantity;
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        // Xử lý lỗi ở đây nếu cần thiết
                    }
                }
            }
            
            

            return subtotal;
        }

        async function calculateCartTotal(cart) {
            const subtotal = await calculateCartSubtotal(cart);
            const vat = 0.08;
            const total = subtotal + (subtotal * vat);
            

            return total;
        }

        async function renderCartProductsTotalAndSubtotal(cart){

            Promise.all([calculateCartSubtotal(cart), calculateCartTotal(cart)])
                .then(([subtotal, total]) => {
                    const subtotalElement = document.getElementById("subtotal");
                    subtotalElement.innerText = `$${subtotal.toFixed(2) || 0}`;

                    const totalElement = document.getElementById("cartTotal");
                    totalElement.innerText = `$${total.toFixed(2) || 0}`;
                });
        }

    </script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>
</html>